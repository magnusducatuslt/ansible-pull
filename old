---
- hosts: all
  connection: local 
  become: yes
  gather_facts: false
  vars:

    # schedule is fed directly to cron
    schedule: '* * * * *'

    # User to run ansible-pull as from cron
    cron_user: root

    # File that ansible will use for logs
    logfile: /Users/magnusducatuslt/spatium/ansible-pull

    # Directory to where repository will be cloned
    workdir: /Users/magnusducatuslt/spatium/ansible-pull/repo

    repo_url: git@bitbucket.org:caspiantechnologies/ansible-pull.git
  tasks:
    # - name: Checkout repo
    #   git:
    #     dest: ./repo
    #     repo: "{{repo_url}}"
    #     update: true
    #     key_file: ~/.ssh/bitbucket
    #     accept_hostkey: yes
    #   register: gitresult
    
    # - debug: msg="SHA-1 before git update is {{ gitresult.before }}"
    # - debug: msg="SHA-1 after git update is {{ gitresult.after }}"

    # - name: Install docker-compose python package
    #   ansible.builtin.pip:
    #     name: docker-compose
    #   when: "'{{gitresult.before}}' != '{{gitresult.after}}'"
    
    # - name: Tear down existing services
    #   community.docker.docker_compose:
    #     project_src: "./"
    #     state: absent
    #   register: "output"
    #   when: "'{{gitresult.before}}' != '{{gitresult.after}}'"

    # - name: Create and start services
    #   community.docker.docker_compose:
    #     project_src: ./
    #   register: output
    
    # - ansible.builtin.debug:
    #     var: output
    
    # - debug: var=output.stdout_lines

    - name: User
      shell: "whoami"
      register: output

    - debug: var=output.stdout_lines
    
    # - name: Create local directory to work from
    #   file: path={{workdir}} state=directory owner=root group=admin mode=0751
    
    # - name: Create crontab entry to clone/pull git repository
    #   template: src=templates/etc_cron.d_ansible-pull.j2 dest=/Users/magnusducatuslt/spatium/ansible-pull/repo owner=root group=admin mode=0644

    # - name: Create logrotate entry for ansible-pull.log
    #   template: src=templates/etc_logrotate.d_ansible-pull.j2 dest=/Users/magnusducatuslt/spatium/ansible-pull/logrotate owner=root group=admin mode=0644
